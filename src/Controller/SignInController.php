<?php

namespace App\Controller;

use App\Entity\Admin;
use App\Entity\Doctors;
use App\Entity\Patients;
use App\Entity\Users;
use App\Form\SignInType;
use Symfony\Bundle\FrameworkBundle\Controller\AbstractController;
use Symfony\Component\HttpFoundation\Cookie;
use Symfony\Component\HttpFoundation\Request;
use Symfony\Component\HttpFoundation\RedirectResponse;
use Symfony\Component\Routing\Annotation\Route;

class SignInController extends AbstractController
{
    /**
     * @Route("/sign/in", name="sign_in", methods={"GET","POST"})
     */
    public function index(Request $request)
    {
        $form = $this->createForm(SignInType::class);
        $form->handleRequest($request);

        if ($form->isSubmitted() && $form->isValid()){
            $login    = $form["login"]->getData();
            $password = $form["password"]->getData();

            $user = $this->getDoctrine()->getRepository(Users::class)->findOneBy([
                'login'    => $login,
                'password' => sha1($password)
            ]);

            if ($user instanceof Admin){
                $response = new RedirectResponse($this->generateUrl('admin'));
                $response->headers->setCookie(new Cookie('login', $login, time() + 3600, '/', null, false, false, true));
                $response->headers->setCookie(new Cookie('password', sha1($password), time() + 3600, '/', null, false, false, true));

                return $response;
            }
        }

        return $this->render('sign_in/index.html.twig', [
            'form' => $form->createView(),
        ]);
    }

    /**
     * @Route("/sign_out", name="sign_out")
     */
    public function signOut(Request $request) {

        $response = new RedirectResponse($this->generateUrl('main'));
        $response->headers->clearCookie('login');
        $response->headers->clearCookie('password');

        return $response;
    }
}
